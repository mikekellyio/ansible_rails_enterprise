###################
# Install openssl #
###################

###################
# Requirements:   #
# * gcc-c++       #
###################

# Detect openssl
- stat: path={{STOW_PATH}}/../bin/openssl
  register: openssl_bin
  changed_when: openssl_bin.stat.exists == false

# Upload & extract source
- { include: upload_src.yml, package: "{{src.openssl}}", pkg_check: "{{openssl_bin}}" }

- name: Install openssl
  when: openssl_bin.stat.exists == false
  register: openssl_install
  shell:
    "{{src_bash}}
    cd {{SRC_PATH}}/{{src_folder.stdout}};
    ./config --prefix={{STOW_PATH}}/{{src_folder.stdout}} \
      --openssldir=ssl --libdir=lib shared;
    make;
    make install prefix={{STOW_PATH}}/{{src_folder.stdout}};
    cd {{STOW_PATH}};
    stow {{src_folder.stdout}};
    creates {{STOW_PATH}}/../bin/openssl;
    "
  ignore_errors: true

- shell: "{{src_bash}} openssl version"
  register: openssl_version
  changed_when: openssl_version.rc != 0

- name: Display openssl version
  debug: msg="{{openssl_version.stdout}}"
